!function(i,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():i.PortalServer=n()}(this,function(){function i(i){if(this.callbacks={},this.allowed_origins=i.allowed_origins||[],this.parentOrigin=void 0,!window.parent)throw new Error("This page is not in an iframe!");if(!window.parent.postMessage)throw new Error("Browser does not support postMessage!");if(window.location.search.slice(1).split("&").forEach(function(i){i=i.split("="),"src"===i[0]&&(this.parentOrigin=decodeURIComponent(i[1]))}.bind(this)),!this.parentOrigin)throw new Error("No target origin provided");if(this.allowed_origins.indexOf(this.parentOrigin)<0)throw new Error("Target origin not allowed")}return i.prototype.on=function(i,n){this.callbacks[i]=n},i.prototype.start=function(){window.addEventListener("message",this.handleMessage.bind(this))},i.prototype.handleMessage=function(i){this.allowed_origins.indexOf(i.origin||i.originalEvent.origin)<0||(i.origin||i.originalEvent.origin)===this.parentOrigin&&this.callbacks[i.data.type]&&this.callbacks[i.data.type](i.data.payload,this.send.bind(this,i.data.response))},i.prototype.send=function(i,n,t){if(!this.parentOrigin)throw new Error("Cannot send message to parent, no parent origin specified");var e=!1;t&&(this.on("_RESPONSE_"+i,function(n){e=!0,this.callbacks["_RESPONSE_"+i]=null,t.call(this,null,n)}.bind(this)),window.setTimeout(function(){var n=new Error("Portal callback for "+i+" timed out");e||t(n)},5e3)),window.parent.postMessage({type:i,payload:n,response:"_RESPONSE_"+i},this.parentOrigin)},i});